# 第2回— Stataプロジェクトの作り方 ＋ データクリーニングの作法

この回は「解析そのもの」ではなく、**解析に耐える土台づくり**を目的にします。  
実務で一番トラブルが起きやすく、それに気づけないと大きな間違いに繋がるのは、回帰や生存解析のコマンドではなく、**データの読み込み・整形・管理**です。ここが曖昧なまま進むと、同じ解析を再現できなかったり、変数の意味が途中でズレたり、doファイルが破綻したりします。

---

## テーマ

**「Stataプロジェクトの作り方 ＋ データクリーニングの作法」**

---

## 到達目標

この回のゴールは3つです。

1) doファイルを**分割する理由**が腹落ちする  
2) 生データ（今回はcsvファイル）を「分析可能なデータ」に変換できる  
3) 次回以降の分析がブレないように、**共通の作法**（命名・ラベル・ログ・保存）を身につける  

---

## データの入手先

- データ：CC0 合成データ（心筋梗塞/脳卒中リスク）
- [Zenodo](https://zenodo.org/records/12567416)

<img width="2118" height="608" alt="image" src="https://github.com/user-attachments/assets/9dc31ec3-6869-4f1a-ac8e-b2fc451f06db" />

## データの内容
- 形式：CSV（comma separated values）
- 重要変数：
  - `patient_id`（個体識別子）
  - `gender`（"M"/"F"）
  - `smoker` や `diabetes` など（bool：true/false想定）
  - `time_to_event_or_censoring`（年単位）
  - `heart_attack_or_stroke_occurred`（イベント発生：bool）

> 注意：この回では **解析（回帰や生存解析）はしません**。  
> 「分析用データセット」を作って保存するところまでがゴールです。

---

# 1. プロジェクト設計

## 1.1 なぜ「1 do = 1役割」なのか

Stata初心者から脱し、doファイルを作るようになると、まず陥りやすい罠として、「とりあえず全部1本のdoに書く」があります。  
短期的には楽ですが、長期的には次の問題が必ず起きます。

- 途中の整形を変更したら、後半の解析が壊れる。
- どこで何をしているか、あとから追えない。
- 同じ処理を別案件で再利用できない。
- 実務で必要な「レビュー」「共同作業」「再現性」が至難になる（最悪の場合、不可能に）。

そこで本コースでは、最初から以下の考え方で進めます。

- **1つ1つのdoファイルは小さく、役割を明確に（モジュール化）**
- **master.do が各モジュールを順に呼び出す**
- どの回でも「読み込み→整形→保存」や「読込み→解析」の流れが追える

---

## 1.2 推奨フォルダ構成

次のような構成を推奨します（手元PCで作れる範囲でOK）。

``` text
project/
├─ data_raw/ # ダウンロードした元データ（絶対に上書きしない）
├─ data_clean/ # 分析用に整形済みデータ
├─ do/ # doファイル置き場
├─ log/ # ログ置き場
└─ output/ # 表・図などの成果物（数が多い時は、分類用にフォルダを増やしても良い）
```

**ポイント**
- `data_raw` は「触らない」領域です。
元データを上書きすると、やり直しができなくなります。
- 整形済みデータは `data_clean` に置きます。
「解析は data_clean から始まる」というルールにするとデータ破壊事故が減ります。

---
## 1.3 master.do の思想

`master.do` は「上から順に処理を流すだけ」の司令塔です。
中身に処理を書きすぎないことが重要です。

- `00_config.do`（環境・パス・共通設定）
- `01_import.do`（読み込み）
- `02_clean.do`（クリーニング）
- （次回以降）`03_table1.do`, `04_models...do` など


---
## 1.4 00_config.do の役割（超重要）

`00_config.do` は「分析の環境」を固定します。
ここがあるだけで再現性が段違いに上がります。

### 00_config.do（サンプル）

``` stata
****************************************************
* 00_config.do
* 役割：環境設定・パス設定・共通オプション
****************************************************


* 1) Stataのバージョン固定（再現性のため）
version 19.0

* 2) 出力の停止を防ぐ
set more off

* 3) 実行結果の表示桁数（好みで調整：通常は触らないで良いので、コメントアウトしている）
// set cformat %9.3f
// set pformat %9.3f
// set sformat %9.3f

* 4) プロジェクトルートの指定
* 受講者PCのパスは環境で異なるため、ここだけ編集すれば良い設計にしている。
global PROJ "C:\stata_course_project" // 例

* 5) よく使うフォルダをグローバルにしておく
global RAW "$PROJ\data_raw"
global CLEAN "$PROJ\data_clean"
global DO "$PROJ\do"
global LOG "$PROJ\log"
global OUT "$PROJ\output"

di "=== Config loaded ==="
di "Project root: $PROJ"
```

### グローバル / ローカルの使い分け（この回の必須）
Stataにおけるグルーバルマクロ / ローカルマクロとは何か？
- global：プロジェクト全体で共有したい（パス、定数）
- local：そのdoファイル内だけで使いたい（共変量リスト、作業用の短期変数）

今回のルール：
- パスは global（例：$RAW）
- 変数リストは local（例：local x age bmi sbp ...）

---
## 1.5 master.do（サンプル）
``` stata
****************************************************
* master.do
* 役割：上から順にモジュールを呼ぶ
****************************************************

* 0) config
// 00_config.doのみは、master.doと同じディレクトリに置く。グローバルマクロ「$DO」の設定は00_config.do内で行うため。
do 00_config.do

* 1) import
// raw.csv -> df00.dta
do "$DO\01_import.do"

* 2) clean
// df00.dta -> df01.dta
do "$DO\02_clean.do"

di "=== Session 2 completed successfully ==="
```

この構造にしておくと、「第2回の範囲は master.do を回せば再現できる」状態になります。

---
# 2. データ読み込み

TSVの読み込みは一見簡単ですが、実務では罠が多いです。
この回では特に次の点を意識します。
- gender が文字列として入る（OK）
- bool（true/false）が文字列として入ることがある（要注意）
- patient_id の重複があると、以後すべてが崩れる（最重要）

## 2.1 01_import.do の作り方

読み込みのdoは「読み込んで保存する」だけにします。
整形は次の 02_clean.do に回します。

01_import.do（サンプル）
